<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Using Terraform for ECS/EC2 | Learning with Rick</title>
<meta name="keywords" content="">
<meta name="description" content="Introduction Today I&rsquo;d like to share my experience of learning the basics of Terraform. I will show how I used it to set up AWS infrastructure to run the FastAPI backend of my notes app. Namely, I will be setting up an ECS cluster with one EC2 provider. I will also share some of the struggles I had to overcome - at least the ones I haven&rsquo;t suppressed.
Setup First, I installed Terraform using the official guide from Hashicorp, using the following commands for my Linux machine:">
<meta name="author" content="">
<link rel="canonical" href="https://rickt.io/posts/10-terraform/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.c298361a052d70fd4ce0d87fac47d88fb063528ceab06c67a460167c3d399bdc.css" integrity="sha256-wpg2GgUtcP1M4Nh/rEfYj7BjUozqsGxnpGAWfD05m9w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://rickt.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://rickt.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://rickt.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://rickt.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://rickt.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YDQ7YKECFZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YDQ7YKECFZ');
</script>
<meta property="og:title" content="Using Terraform for ECS/EC2" />
<meta property="og:description" content="Introduction Today I&rsquo;d like to share my experience of learning the basics of Terraform. I will show how I used it to set up AWS infrastructure to run the FastAPI backend of my notes app. Namely, I will be setting up an ECS cluster with one EC2 provider. I will also share some of the struggles I had to overcome - at least the ones I haven&rsquo;t suppressed.
Setup First, I installed Terraform using the official guide from Hashicorp, using the following commands for my Linux machine:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rickt.io/posts/10-terraform/" />
<meta property="og:image" content="https://rickt.io/images/terraform.svg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-12-17T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://rickt.io/images/terraform.svg" />
<meta name="twitter:title" content="Using Terraform for ECS/EC2"/>
<meta name="twitter:description" content="Introduction Today I&rsquo;d like to share my experience of learning the basics of Terraform. I will show how I used it to set up AWS infrastructure to run the FastAPI backend of my notes app. Namely, I will be setting up an ECS cluster with one EC2 provider. I will also share some of the struggles I had to overcome - at least the ones I haven&rsquo;t suppressed.
Setup First, I installed Terraform using the official guide from Hashicorp, using the following commands for my Linux machine:"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://rickt.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Using Terraform for ECS/EC2",
      "item": "https://rickt.io/posts/10-terraform/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Using Terraform for ECS/EC2",
  "name": "Using Terraform for ECS\/EC2",
  "description": "Introduction Today I\u0026rsquo;d like to share my experience of learning the basics of Terraform. I will show how I used it to set up AWS infrastructure to run the FastAPI backend of my notes app. Namely, I will be setting up an ECS cluster with one EC2 provider. I will also share some of the struggles I had to overcome - at least the ones I haven\u0026rsquo;t suppressed.\nSetup First, I installed Terraform using the official guide from Hashicorp, using the following commands for my Linux machine:",
  "keywords": [
    
  ],
  "articleBody": "Introduction Today I’d like to share my experience of learning the basics of Terraform. I will show how I used it to set up AWS infrastructure to run the FastAPI backend of my notes app. Namely, I will be setting up an ECS cluster with one EC2 provider. I will also share some of the struggles I had to overcome - at least the ones I haven’t suppressed.\nSetup First, I installed Terraform using the official guide from Hashicorp, using the following commands for my Linux machine:\nwget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg echo \"deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs)main\" | sudo tee /etc/apt/sources.list.d/hashicorp.list sudo apt update \u0026\u0026 sudo apt install terraform Then, I created a main.tf file in a new terraform folder under my notes app folder, and added the following to define the AWS provider:\nprovider \"aws\" { region = \"us-west-2\" } Normally at this point one would need to configure AWS CLI authentication, which Terraform can use to communicate with the AWS API, but I had done this previously. You can read about it in my post - Deploying a Website to S3 Using AWS CLI.\nFrom here, I ran terraform init to initialize the file structure and pull down provider requirements.\nAdding Network Resources Next, I added the resources for a basic network layout to main.tf:\nprovider \"aws\" { region = \"us-west-2\" }# VPC resource \"aws_vpc\" \"notes-prod-vpc\" { cidr_block = \"10.0.0.0/16\" }# Internet Gateway resource \"aws_internet_gateway\" \"notes-prod-gw\" { vpc_id = aws_vpc.notes-prod-vpc.id }# Route Table resource \"aws_route_table\" \"notes-prod-rt\" { vpc_id = aws_vpc.notes-prod-vpc.id route { cidr_block = \"0.0.0.0/0\" gateway_id = aws_internet_gateway.notes-prod-gw.id } route { ipv6_cidr_block = \"::/0\" gateway_id = aws_internet_gateway.notes-prod-gw.id } }# Subnet resource \"aws_subnet\" \"notes-prod-subnet\" { vpc_id = aws_vpc.notes-prod-vpc.id cidr_block = \"10.0.1.0/24\" availability_zone = \"us-west-2a\" map_public_ip_on_launch = true }# Associate subnet with Route Table resource \"aws_route_table_association\" \"a\" { subnet_id = aws_subnet.notes-prod-subnet.id route_table_id = aws_route_table.notes-prod-rt.id }# Security Group resource \"aws_security_group\" \"notes-prod-sg\" { name = \"notes-prod-sg\" description = \"Allow inbound web traffic\" vpc_id = aws_vpc.notes-prod-vpc.id ingress { description = \"HTTPS\" from_port = 443 to_port = 443 protocol = \"tcp\" cidr_blocks = [\"0.0.0.0/0\"] } ingress { description = \"HTTP\" from_port = 80 to_port = 80 protocol = \"tcp\" cidr_blocks = [\"0.0.0.0/0\"] } ingress { description = \"MongoDB_Atlas\" from_port = 27017 to_port = 27017 protocol = \"tcp\" cidr_blocks = [\"0.0.0.0/0\"] } ingress { description = \"SSH\" from_port = 22 to_port = 22 protocol = \"tcp\" cidr_blocks = [\"0.0.0.0/0\"] } egress { from_port = 0 to_port = 0 protocol = \"-1\" cidr_blocks = [\"0.0.0.0/0\"] } } Then I ran terraform apply to create these resources and checked that they worked in the AWS console.\nThis part of the setup was pretty straightforward. The only part that tripped me up was later when everything was working except communication to the MongoDB Atlas database, which I quickly realized was because I hadn’t added a rule for it in the Security Group.\nDefining an EC2 Instance To set up the EC2 instance definition that would be the compute provider for my ECS cluster, I created a file named ec2.tf and added the following:\nresource \"aws_launch_template\" \"notes-prod-lt\" { name_prefix = \"notes-prod\" image_id = \"ami-0f53d557e55fc7064\" instance_type = \"t3.nano\" key_name = \"Key1\" network_interfaces { security_groups = [aws_security_group.notes-prod-sg.id] subnet_id = aws_subnet.notes-prod-subnet.id } iam_instance_profile { name = \"ecsInstanceRole\" } block_device_mappings { device_name = \"/dev/xvda\" ebs { volume_type = \"gp3\" volume_size = 30 } } user_data = filebase64(\"${path.module}/ec2.sh\") } A few things things to note:\n image_id: This is an Amazon Linux image, which comes with Docker preinstalled. key_name: This is an ssh key that I had created previously. It isn’t required to function, but it was incredibly valuable for troubleshooting. iam_instance_profile: This is required and the role needs to be created from a predefined IAM role. I used the official documentation to set it up in the console. user_data: This gives ECS the ability to deploy and run Docker contianers on our EC2 instance by definining an environment variable. It imports the file that I created, ec2.sh, which I added the following to:  #!/bin/bash echo ECS_CLUSTER=notes-prod  /etc/ecs/ecs.config Next, I added an autoscaling group to ec2.tf, even though we’re not actually doing any scaling, because it is required for ECS.\nresource \"aws_autoscaling_group\" \"notes-prod-asg\" { name = \"notes-prod-asg\" max_size = 1 min_size = 1 desired_capacity = 1 launch_template { id = aws_launch_template.notes-prod-lt.id } } Setting up ECS The last, and most difficult task, was to define the ECS infrastructure. To do that, I created a file named ecs.tf and started off by adding the cluster resource:\nresource \"aws_ecs_cluster\" \"notes-prod-ecs_cluster\" { name = \"notes-prod\" } Then, I added the task definition resource. This does all of the heavy lifting:\nresource \"aws_ecs_task_definition\" \"notes-prod-ecs_td\" { container_definitions = TASK_DEFINITION [ { \"cpu\": 0, \"environment\": [], \"essential\": true, \"image\": \"584916250327.dkr.ecr.us-west-2.amazonaws.com/notes-api:latest\", \"name\": \"notes-api-container\", \"portMappings\": [ { \"containerPort\": 8000, \"hostPort\": 80, \"name\": \"notes-api-container-8000-tcp\", \"protocol\": \"tcp\" } ], \"volumesFrom\": [], \"secrets\": [ { \"name\": \"MONGO_USER\", \"valueFrom\": \"arn:aws:secretsmanager:us-west-2:584916250327:secret:notes-mongo-eIdNP9:MONGO_USER::\" }, { \"name\": \"MONGO_PASS\", \"valueFrom\": \"arn:aws:secretsmanager:us-west-2:584916250327:secret:notes-mongo-eIdNP9:MONGO_PASS::\" } ] } ] TASK_DEFINITION cpu = \"1024\" execution_role_arn = \"arn:aws:iam::584916250327:role/ecsTaskExecutionRole\" family = \"notes-prod-task\" memory = \"64\" requires_compatibilities = [\"EC2\"] } I spent many hours getting this part right. I love building automation, and one of the most challenging things to do when using automation tools that abstract the underlying processes is learning how to gain the visibility needed to be able to troubleshoot effectively. I had to learn where to look in Cloudwatch, the EC2 instance, and the Docker container.\nEventually, I found that I had assigned too much memory to the task, as it was in excess of the small amount of memory available to a t3.nano instance. This caused the task to fail, while giving no real error message in the AWS console.\nThe last resource needed in the ecs.tf file was the ECS service:\nresource \"aws_ecs_service\" \"notes-prod-ecs_service\" { name = \"notes-prod-ecs_service\" cluster = aws_ecs_cluster.notes-prod-ecs_cluster.id task_definition = aws_ecs_task_definition.notes-prod-ecs_td.arn scheduling_strategy = \"DAEMON\" } Conclusion This was a long, difficult, and rewarding project. It’s funny, because I don’t remember all of the different ways that I struggled to get this working. I think the sense of accomplishment overshadows the struggle. There’s something so gratifying and empowering to having code be the single source of truth for infrastructure and I’m proud of the effort it took to get there.\nI’d like to expand on this infrastructure by adding a second EC2 instance to the cluster with a load balancer and perhaps play with auto scaling, but I might go down the Kubernetes rabbit hole instead. Either way, I look forward to the next challenge.\nYou can see the notes app in action at http://notes.rickt.io/ and the Github repo for it, including the Terraform code here\nCheers!\nRick\n   Resources  Terraform in Two Hours (freeCodeCamp) - https://www.youtube.com/watch?v=SLB_c_ayRMo How to Deploy an AWS ECS Cluster with Terraform (spacelift) - https://spacelift.io/blog/terraform-ecs  ",
  "wordCount" : "1122",
  "inLanguage": "en",
  "image":"https://rickt.io/images/terraform.svg","datePublished": "2023-12-17T00:00:00Z",
  "dateModified": "2023-12-17T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://rickt.io/posts/10-terraform/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Learning with Rick",
    "logo": {
      "@type": "ImageObject",
      "url": "https://rickt.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://rickt.io/" accesskey="h" title="Learning with Rick (Alt + H)">Learning with Rick</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://rickt.io/">Home</a>&nbsp;»&nbsp;<a href="https://rickt.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Using Terraform for ECS/EC2
    </h1>
    <div class="post-meta"><span title='2023-12-17 00:00:00 +0000 UTC'>December 17, 2023</span>&nbsp;·&nbsp;6 min

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://rickt.io/images/terraform.svg" alt="">
        
</figure>
  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>Today I&rsquo;d like to share my experience of learning the basics of Terraform. I will show how I used it to set up AWS infrastructure to run the FastAPI backend of my <a href="https://rickt.io/posts/04-creating-a-basic-notes-app-using-the-farm-stack/">notes app</a>. Namely, I will be setting up an ECS cluster with one EC2 provider. I will also share some of the struggles I had to overcome - at least the ones I haven&rsquo;t suppressed.</p>
<h2 id="setup">Setup<a hidden class="anchor" aria-hidden="true" href="#setup">#</a></h2>
<p>First, I installed Terraform using the <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">official guide from Hashicorp</a>, using the following commands for my Linux machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com </span><span style="color:#ff79c6">$(</span>lsb_release -cs<span style="color:#ff79c6">)</span><span style="color:#f1fa8c"> main&#34;</span> | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update <span style="color:#ff79c6">&amp;&amp;</span> sudo apt install terraform
</code></pre></div><p>Then, I created a <code>main.tf</code> file in a new <code>terraform</code> folder under my <code>notes</code> app folder, and added the following to define the AWS provider:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#ff79c6">provider</span> <span style="color:#f1fa8c">&#34;aws&#34;</span> {
    region <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;us-west-2&#34;</span>
}
</code></pre></div><p>Normally at this point one would need to configure AWS CLI authentication, which Terraform can use to communicate with the AWS API, but I had done this previously. You can read about it in my post - <a href="https://rickt.io/posts/02-deploying-a-website-to-s3-using-aws-cli/">Deploying a Website to S3 Using AWS CLI</a>.</p>
<p>From here, I ran <code>terraform init</code> to initialize the file structure and pull down provider requirements.</p>
<h2 id="adding-network-resources">Adding Network Resources<a hidden class="anchor" aria-hidden="true" href="#adding-network-resources">#</a></h2>
<p>Next, I added the resources for a basic network layout to <code>main.tf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#ff79c6">provider</span> <span style="color:#f1fa8c">&#34;aws&#34;</span> {
    region <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;us-west-2&#34;</span>
}<span style="color:#6272a4">
</span><span style="color:#6272a4">
</span><span style="color:#6272a4"># VPC
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_vpc&#34; &#34;notes-prod-vpc&#34;</span> {
    cidr_block <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;10.0.0.0/16&#34;</span>
}<span style="color:#6272a4">
</span><span style="color:#6272a4">
</span><span style="color:#6272a4"># Internet Gateway
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_internet_gateway&#34; &#34;notes-prod-gw&#34;</span> {
    vpc_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_vpc</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">vpc</span>.<span style="color:#ff79c6">id</span>
}<span style="color:#6272a4">
</span><span style="color:#6272a4">
</span><span style="color:#6272a4"># Route Table
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_route_table&#34; &#34;notes-prod-rt&#34;</span> {
    vpc_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_vpc</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">vpc</span>.<span style="color:#ff79c6">id</span>

    <span style="color:#ff79c6">route</span> {
        cidr_block <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;0.0.0.0/0&#34;</span>
        gateway_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_internet_gateway</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">gw</span>.<span style="color:#ff79c6">id</span>
    }

    <span style="color:#ff79c6">route</span> {
        ipv6_cidr_block        <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;::/0&#34;</span>
        gateway_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_internet_gateway</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">gw</span>.<span style="color:#ff79c6">id</span>
    }
}<span style="color:#6272a4">
</span><span style="color:#6272a4">
</span><span style="color:#6272a4"># Subnet
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_subnet&#34; &#34;notes-prod-subnet&#34;</span> {
    vpc_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_vpc</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">vpc</span>.<span style="color:#ff79c6">id</span>
    cidr_block <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;10.0.1.0/24&#34;</span>
    availability_zone <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;us-west-2a&#34;</span>
    map_public_ip_on_launch <span style="color:#ff79c6">=</span> <span style="color:#8be9fd">true</span>
}<span style="color:#6272a4">
</span><span style="color:#6272a4">
</span><span style="color:#6272a4"># Associate subnet with Route Table
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_route_table_association&#34; &#34;a&#34;</span> {
    subnet_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_subnet</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">subnet</span>.<span style="color:#ff79c6">id</span>
    route_table_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_route_table</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">rt</span>.<span style="color:#ff79c6">id</span>
}<span style="color:#6272a4">
</span><span style="color:#6272a4">
</span><span style="color:#6272a4"># Security Group
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_security_group&#34; &#34;notes-prod-sg&#34;</span> {
    name        <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;notes-prod-sg&#34;</span>
    description <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Allow inbound web traffic&#34;</span>
    vpc_id      <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_vpc</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">vpc</span>.<span style="color:#ff79c6">id</span>

    <span style="color:#ff79c6">ingress</span> {
        description <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;HTTPS&#34;</span>
        from_port   <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">443</span>
        to_port     <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">443</span>
        protocol    <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tcp&#34;</span>
        cidr_blocks <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;0.0.0.0/0&#34;</span>]
    }

    <span style="color:#ff79c6">ingress</span> {
        description <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;HTTP&#34;</span>
        from_port   <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">80</span>
        to_port     <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">80</span>
        protocol    <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tcp&#34;</span>
        cidr_blocks <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;0.0.0.0/0&#34;</span>]
    }

    <span style="color:#ff79c6">ingress</span> {
        description <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;MongoDB_Atlas&#34;</span>
        from_port   <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">27017</span>
        to_port     <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">27017</span>
        protocol    <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tcp&#34;</span>
        cidr_blocks <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;0.0.0.0/0&#34;</span>]
    }

    <span style="color:#ff79c6">ingress</span> {
        description <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;SSH&#34;</span>
        from_port   <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">22</span>
        to_port     <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">22</span>
        protocol    <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tcp&#34;</span>
        cidr_blocks <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;0.0.0.0/0&#34;</span>]
    }

    <span style="color:#ff79c6">egress</span> {
        from_port <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
        to_port <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
        protocol <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;-1&#34;</span>
        cidr_blocks <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;0.0.0.0/0&#34;</span>]
    }
}
</code></pre></div><p>Then I ran <code>terraform apply</code> to create these resources and checked that they worked in the AWS console.</p>
<p>This part of the setup was pretty straightforward. The only part that tripped me up was later when everything was working except communication to the MongoDB Atlas database, which I quickly realized was because I hadn&rsquo;t added a rule for it in the Security Group.</p>
<h2 id="defining-an-ec2-instance">Defining an EC2 Instance<a hidden class="anchor" aria-hidden="true" href="#defining-an-ec2-instance">#</a></h2>
<p>To set up the EC2 instance definition that would be the compute provider for my ECS cluster, I created a file named <code>ec2.tf</code> and added the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_launch_template&#34; &#34;notes-prod-lt&#34;</span> {
    name_prefix <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;notes-prod&#34;</span>
    image_id <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ami-0f53d557e55fc7064&#34;</span>
    instance_type <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;t3.nano&#34;</span>
    key_name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Key1&#34;</span>

    <span style="color:#ff79c6">network_interfaces</span> {
        security_groups <span style="color:#ff79c6">=</span> [<span style="color:#ff79c6">aws_security_group</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">sg</span>.<span style="color:#ff79c6">id</span>]
        subnet_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_subnet</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">subnet</span>.<span style="color:#ff79c6">id</span>
    }

    <span style="color:#ff79c6">iam_instance_profile</span> {
        name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ecsInstanceRole&#34;</span>
    }

    <span style="color:#ff79c6">block_device_mappings</span> {
        device_name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/dev/xvda&#34;</span>
        <span style="color:#ff79c6">ebs</span> {
            volume_type <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;gp3&#34;</span>
            volume_size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">30</span>
        }
    }   
    user_data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">filebase64</span>(<span style="color:#f1fa8c">&#34;${path.module}/ec2.sh&#34;</span>)
}
</code></pre></div><p>A few things things to note:</p>
<ul>
<li><strong>image_id</strong>: This is an Amazon Linux image, which comes with Docker preinstalled.</li>
<li><strong>key_name</strong>: This is an ssh key that I had created previously. It isn&rsquo;t required to function, but it was incredibly valuable for troubleshooting.</li>
<li><strong>iam_instance_profile</strong>: This is required and the role needs to be created from a predefined IAM role. I used the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html">official documentation</a> to set it up in the console.</li>
<li><strong>user_data</strong>:  This gives ECS the ability to deploy and run Docker contianers on our EC2 instance by definining an environment variable. It imports the file that I created, <code>ec2.sh</code>, which I added the following to:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#ff79c6">#!/bin/bash
</span><span style="color:#ff79c6"></span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">ECS_CLUSTER</span><span style="color:#ff79c6">=</span>notes-prod &gt;&gt; /etc/ecs/ecs.config
</code></pre></div><p>Next, I added an autoscaling group to <code>ec2.tf</code>, even though we&rsquo;re not actually doing any scaling, because it is required for ECS.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_autoscaling_group&#34; &#34;notes-prod-asg&#34;</span> {
    name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;notes-prod-asg&#34;</span>
    max_size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
    min_size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
    desired_capacity <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>
    <span style="color:#ff79c6">launch_template</span> {
        id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_launch_template</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">lt</span>.<span style="color:#ff79c6">id</span>
    }
}
</code></pre></div><h2 id="setting-up-ecs">Setting up ECS<a hidden class="anchor" aria-hidden="true" href="#setting-up-ecs">#</a></h2>
<p>The last, and most difficult task, was to define the ECS infrastructure. To do that, I created a file named <code>ecs.tf</code> and started off by adding the cluster resource:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_ecs_cluster&#34; &#34;notes-prod-ecs_cluster&#34;</span> {
  name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;notes-prod&#34;</span>
}
</code></pre></div><p>Then, I added the task definition resource. This does all of the heavy lifting:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_ecs_task_definition&#34; &#34;notes-prod-ecs_td&#34;</span> {
  container_definitions <span style="color:#ff79c6">=</span> &lt;&lt;<span style="color:#ff79c6">TASK_DEFINITION</span>
[
  {
    <span style="color:#f1fa8c">&#34;cpu&#34;</span>: <span style="color:#bd93f9">0</span>,
    <span style="color:#f1fa8c">&#34;environment&#34;</span>: [],
    <span style="color:#f1fa8c">&#34;essential&#34;</span>: <span style="color:#8be9fd">true</span>,
    <span style="color:#f1fa8c">&#34;image&#34;: &#34;584916250327.dkr.ecr.us-west-2.amazonaws.com/notes-api:latest&#34;</span>,
    <span style="color:#f1fa8c">&#34;name&#34;: &#34;notes-api-container&#34;</span>,
    <span style="color:#f1fa8c">&#34;portMappings&#34;</span>: [
      {
        <span style="color:#f1fa8c">&#34;containerPort&#34;</span>: <span style="color:#bd93f9">8000</span>,
        <span style="color:#f1fa8c">&#34;hostPort&#34;</span>: <span style="color:#bd93f9">80</span>,
        <span style="color:#f1fa8c">&#34;name&#34;: &#34;notes-api-container-8000-tcp&#34;</span>,
        <span style="color:#f1fa8c">&#34;protocol&#34;: &#34;tcp&#34;</span>
      }
    ],
    <span style="color:#f1fa8c">&#34;volumesFrom&#34;</span>: [],
    <span style="color:#f1fa8c">&#34;secrets&#34;</span>: [
      {
        <span style="color:#f1fa8c">&#34;name&#34;: &#34;MONGO_USER&#34;</span>,
        <span style="color:#f1fa8c">&#34;valueFrom&#34;: &#34;arn:aws:secretsmanager:us-west-2:584916250327:secret:notes-mongo-eIdNP9:MONGO_USER::&#34;</span>
      },
      {
        <span style="color:#f1fa8c">&#34;name&#34;: &#34;MONGO_PASS&#34;</span>,
        <span style="color:#f1fa8c">&#34;valueFrom&#34;: &#34;arn:aws:secretsmanager:us-west-2:584916250327:secret:notes-mongo-eIdNP9:MONGO_PASS::&#34;</span>
      }
    ]
  }
]
  <span style="color:#ff79c6">TASK_DEFINITION</span>
  cpu <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;1024&#34;</span>
  execution_role_arn <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;arn:aws:iam::584916250327:role/ecsTaskExecutionRole&#34;</span>
  family <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;notes-prod-task&#34;</span>
  memory <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;64&#34;</span>
  requires_compatibilities <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;EC2&#34;</span>]
}
</code></pre></div><p>I spent many hours getting this part right. I love building automation, and one of the most challenging things to do when using automation tools that abstract the underlying processes is learning how to gain the visibility needed to be able to troubleshoot effectively. I had to learn where to look in Cloudwatch, the EC2 instance, and the Docker container.</p>
<p>Eventually, I found that I had assigned too much memory to the task, as it was in excess of the small amount of memory available to a t3.nano instance. This caused the task to fail, while giving no real error message in the AWS console.</p>
<p>The last resource needed in the <code>ecs.tf</code> file was the ECS service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;aws_ecs_service&#34; &#34;notes-prod-ecs_service&#34;</span> {
  name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;notes-prod-ecs_service&#34;</span>
  cluster <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_ecs_cluster</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">ecs_cluster</span>.<span style="color:#ff79c6">id</span>
  task_definition <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">aws_ecs_task_definition</span>.<span style="color:#ff79c6">notes</span>-<span style="color:#ff79c6">prod</span>-<span style="color:#ff79c6">ecs_td</span>.<span style="color:#ff79c6">arn</span>
  scheduling_strategy <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;DAEMON&#34;</span>
}
</code></pre></div><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>This was a long, difficult, and rewarding project. It&rsquo;s funny, because I don&rsquo;t remember all of the different ways that I struggled to get this working. I think the sense of accomplishment overshadows the struggle. There&rsquo;s something so gratifying and empowering to having code be the single source of truth for infrastructure and I&rsquo;m proud of the effort it took to get there.</p>
<p>I&rsquo;d like to expand on this infrastructure by adding a second EC2 instance to the cluster with a load balancer and perhaps play with auto scaling, but I might go down the Kubernetes rabbit hole instead. Either way, I look forward to the next challenge.</p>
<p>You can see the notes app in action at <a href="http://notes.rickt.io/">http://notes.rickt.io/</a> and the Github repo for it, including the Terraform code <a href="https://github.com/rickthackeray/notes">here</a></p>
<p>Cheers!<br>
Rick</p>
<p> </p>
<p> </p>
<hr>
<h3 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h3>
<ul>
<li>Terraform in Two Hours (<a href="https://www.freecodecamp.org/">freeCodeCamp</a>) - <a href="https://www.youtube.com/watch?v=SLB_c_ayRMo">https://www.youtube.com/watch?v=SLB_c_ayRMo</a></li>
<li>How to Deploy an AWS ECS Cluster with Terraform (spacelift) - <a href="https://spacelift.io/blog/terraform-ecs">https://spacelift.io/blog/terraform-ecs</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://rickt.io/posts/09-load-balancing-a-fastapi-app-with-nginx-and-docker/">
    <span class="title">Next »</span>
    <br>
    <span>Load Balancing Using Nginx and Docker</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://rickt.io/">Learning with Rick</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
